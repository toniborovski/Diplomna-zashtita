<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Дипломна защита - 48V DC/DC Преобразувател</title>

  <style>
    :root{
      --bg-primary:#f8fafc;
      --bg-secondary:#ffffff;
      --text-primary:#1e293b;
      --text-secondary:#475569;
      --accent-primary:#1e40af;
      --accent-hover:#1d4ed8;
      --border-color:#e2e8f0;
      --shadow:0 10px 25px rgba(0,0,0,0.1);
      --chip-bg: rgba(255,255,255,0.75);
      --glass: rgba(255,255,255,0.85);
    }

    /* Dark mode */
    html.dark{
      --bg-primary:#0b1220;
      --bg-secondary:#0f172a;
      --text-primary:#e5e7eb;
      --text-secondary:#9ca3af;
      --accent-primary:#60a5fa;
      --accent-hover:#93c5fd;
      --border-color:#1f2a44;
      --shadow:0 18px 40px rgba(0,0,0,0.35);
      --chip-bg: rgba(15,23,42,0.75);
      --glass: rgba(15,23,42,0.88);
    }

    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:var(--bg-primary);
      color:var(--text-primary);
      overflow:hidden;
    }

    .slide-container{
      width:100vw;height:100vh;position:relative;background:var(--bg-primary);
    }

    .slide{
      width:100%;height:100%;
      position:absolute;top:0;left:0;
      opacity:0;transform:translateX(100%);
      transition:all 0.6s cubic-bezier(0.25,0.46,0.45,0.94);
      padding:80px;
      display:flex;flex-direction:column;justify-content:center;
      background:var(--bg-secondary);
      box-shadow:var(--shadow);
    }
    .slide.active{opacity:1;transform:translateX(0)}
    .slide.prev{transform:translateX(-100%)}

    h1{font-size:3.2rem;font-weight:800;color:var(--text-primary);margin-bottom:1.5rem;line-height:1.1}
    h2{font-size:2.5rem;font-weight:800;color:var(--accent-primary);margin-bottom:2rem}
    h3{font-size:1.6rem;font-weight:800;color:var(--text-primary);margin-bottom:1rem}
    p,li{font-size:1.3rem;font-weight:650;color:var(--text-primary);line-height:1.6;margin-bottom:1rem}

    ul{list-style:none;padding-left:0}
    li{position:relative;padding-left:2rem;margin-bottom:1.2rem}
    li::before{content:"▸";position:absolute;left:0;color:var(--accent-primary);font-weight:900;font-size:1.4rem}

    .content-grid{display:grid;grid-template-columns:1fr 1fr;gap:3rem;height:70%}
    .content-left{display:flex;flex-direction:column;justify-content:center}

    .image-placeholder{
      background:linear-gradient(135deg,#e2e8f0 0%,#cbd5e1 100%);
      border:3px dashed #94a3b3;
      border-radius:12px;
      height:300px;
      display:flex;align-items:center;justify-content:center;flex-direction:column;
      text-align:center;color:var(--text-secondary);
      cursor:pointer;
      user-select:none;
      transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    html.dark .image-placeholder{
      background:linear-gradient(135deg,#111b31 0%,#0b1220 100%);
      border-color:#334155;
      color:var(--text-secondary);
    }
    .image-placeholder:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(0,0,0,0.15);border-color:var(--accent-primary)}
    .image-placeholder h4{font-size:1.1rem;margin-bottom:.5rem;color:var(--text-primary)}
    .image-placeholder small{opacity:.8}

    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:1.5rem;margin-top:2rem;
    }
    .stat-card{
      background:rgba(255,255,255,0.85);
      padding:2rem;border-radius:14px;
      border-left:5px solid var(--accent-primary);
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
      text-align:center;
      backdrop-filter: blur(8px);
    }
    html.dark .stat-card{background:rgba(15,23,42,0.75)}
    .stat-value{font-size:2.5rem;font-weight:900;color:var(--accent-primary);display:block}
    .stat-label{font-size:1rem;color:var(--text-secondary);margin-top:.5rem}

    .center-content{text-align:center;display:flex;flex-direction:column;justify-content:center;align-items:center;height:70%}
    .highlight{color:var(--accent-primary);font-weight:900}

    /* Top info row */
    .topbar{
      position:fixed;top:14px;left:14px;right:14px;
      display:flex;align-items:center;justify-content:space-between;
      z-index:2000;
      pointer-events:none;
    }
    .topbar .left, .topbar .right{
      display:flex;align-items:center;gap:10px;
      pointer-events:auto;
    }
    .chip{
      background:var(--chip-bg);
      border:1px solid var(--border-color);
      padding:10px 14px;border-radius:999px;
      font-weight:850;font-size:1rem;color:var(--text-primary);
      backdrop-filter: blur(10px);
      box-shadow:0 10px 25px rgba(0,0,0,0.10);
      user-select:none;
    }
    .chip.mono{font-variant-numeric:tabular-nums}
    .chip subtle{opacity:.8}

    /* Progress bar */
    .progress{
      position:fixed;left:0;top:0;height:6px;width:100%;
      background:rgba(226,232,240,0.9);z-index:2100;
    }
    html.dark .progress{background:rgba(31,42,68,0.9)}
    .progress > div{
      height:100%;width:0%;
      background:var(--accent-primary);
      transition:width 0.25s ease;
    }

    /* Bottom navigation bar */
    .nav{
      position:fixed;bottom:18px;left:50%;
      transform:translateX(-50%);
      z-index:2000;
      display:flex;gap:10px;align-items:center;
      padding:10px 12px;border-radius:999px;
      background:var(--glass);
      border:1px solid var(--border-color);
      backdrop-filter: blur(10px);
      box-shadow:0 14px 30px rgba(0,0,0,0.14);
    }
    .nav-btn{
      background:var(--accent-primary);color:white;border:none;
      padding:12px 16px;border-radius:999px;
      font-size:1.02rem;font-weight:850;cursor:pointer;
      transition:all 0.2s ease;
      box-shadow:0 8px 18px rgba(30,64,175,0.25);
      user-select:none;
      white-space:nowrap;
    }
    .nav-btn:hover{background:var(--accent-hover);transform:translateY(-1px)}
    .nav-btn:disabled{background:#94a3b3;cursor:not-allowed;transform:none;box-shadow:none}
    html.dark .nav-btn:disabled{background:#475569}

    .nav-ghost{
      background:transparent;color:var(--text-primary);
      border:1px solid var(--border-color);
      box-shadow:none;
    }
    .nav-ghost:hover{background:rgba(148,163,184,0.15)}
    html.dark .nav-ghost:hover{background:rgba(148,163,184,0.10)}

    select.jump{
      border:1px solid var(--border-color);
      background:transparent;
      padding:10px 12px;border-radius:999px;
      font-weight:850;color:var(--text-primary);
      outline:none;
      max-width:260px;
    }

    /* Notes */
    .notes{
      position:fixed;left:14px;top:64px;z-index:2200;
      max-width:min(520px, 55vw);
      background:var(--glass);
      border:1px solid var(--border-color);
      border-radius:16px;
      box-shadow:0 18px 40px rgba(0,0,0,0.18);
      padding:14px 16px;
      display:none;
      backdrop-filter: blur(10px);
    }
    .notes h4{margin-bottom:8px;color:var(--accent-primary);font-size:1rem}
    .notes p{font-size:1.05rem;font-weight:650;color:var(--text-primary);margin-bottom:0}

    /* Help overlay */
    .overlay{
      position:fixed;inset:0;z-index:3000;
      background:rgba(0,0,0,0.55);
      display:none;
      align-items:center;justify-content:center;
      padding:20px;
    }
    .panel{
      width:min(920px, 96vw);
      background:var(--bg-secondary);
      color:var(--text-primary);
      border:1px solid var(--border-color);
      border-radius:18px;
      box-shadow:0 26px 70px rgba(0,0,0,0.35);
      padding:18px;
      max-height:86vh;
      overflow:auto;
    }
    .panel h3{margin-bottom:12px}
    .panel .grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(260px, 1fr));
      gap:10px 16px;
    }
    .kbd{
      display:flex;gap:10px;align-items:flex-start;
      padding:10px 12px;border-radius:14px;
      border:1px solid var(--border-color);
      background:rgba(148,163,184,0.08);
    }
    html.dark .panel{background:var(--bg-secondary)}
    .kbd code{
      background:rgba(30,64,175,0.12);
      border:1px solid rgba(30,64,175,0.25);
      padding:4px 8px;border-radius:10px;
      font-weight:900;
      color:var(--accent-primary);
    }
    .panel .row{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:10px;
    }

    /* Overview grid */
    .overview-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
      gap:12px;
    }
    .thumb{
      border:1px solid var(--border-color);
      border-radius:14px;
      padding:12px;
      background:rgba(148,163,184,0.08);
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
      user-select:none;
      min-height:120px;
    }
    .thumb:hover{transform:translateY(-2px);box-shadow:0 12px 26px rgba(0,0,0,0.16)}
    .thumb b{display:block;margin-bottom:6px;color:var(--accent-primary)}
    .thumb span{color:var(--text-secondary);font-weight:650}

    /* Image/PDF modal */
    .modal{
      position:fixed;inset:0;z-index:3500;
      background:rgba(0,0,0,0.62);
      display:none;
      align-items:center;justify-content:center;
      padding:18px;
    }
    .modal-card{
      width:min(1200px, 96vw);
      height:min(86vh, 900px);
      background:var(--bg-secondary);
      border-radius:18px;
      border:1px solid var(--border-color);
      box-shadow:0 26px 70px rgba(0,0,0,0.40);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modal-top{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--border-color);
      background:rgba(148,163,184,0.08);
    }
    .modal-title{
      font-weight:900;
      color:var(--text-primary);
      display:flex;gap:10px;align-items:center;
      flex-wrap:wrap;
    }
    .modal-actions{display:flex;gap:8px;align-items:center}
    .icon-btn{
      border:1px solid var(--border-color);
      background:transparent;color:var(--text-primary);
      padding:8px 10px;border-radius:12px;
      cursor:pointer;font-weight:900;
    }
    .icon-btn:hover{background:rgba(148,163,184,0.15)}
    .modal-body{
      flex:1;
      background:#0b1020;
      display:flex;align-items:center;justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .modal-body img{
      max-width:none;
      transform-origin:center center;
      user-select:none;
      -webkit-user-drag:none;
    }
    .modal-body iframe{
      width:100%;height:100%;
      border:0;
      background:white;
    }

    /* Annotation / laser layers */
    .layers{
      position:fixed;inset:0;z-index:2500;
      pointer-events:none;
    }
    #drawCanvas{
      width:100vw;height:100vh;
      pointer-events:none;
    }
    .laser-dot{
      position:fixed;
      width:16px;height:16px;border-radius:50%;
      background:rgba(255, 0, 0, 0.85);
      box-shadow:0 0 18px rgba(255,0,0,0.75);
      transform:translate(-50%,-50%);
      display:none;
      z-index:2600;
      pointer-events:none;
    }

    /* Live widget (slide 10) */
    .widget{
      margin-top:18px;
      padding:16px 18px;
      border:1px solid var(--border-color);
      border-radius:16px;
      background:rgba(148,163,184,0.08);
      max-width:760px;
    }
    .widget .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .widget label{display:block;font-weight:850;color:var(--text-secondary);margin-bottom:6px}
    .widget input[type="range"]{width:100%}
    .widget .out{
      display:grid;
      grid-template-columns:repeat(3, minmax(120px, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .pill{
      padding:10px 12px;border-radius:14px;
      background:rgba(255,255,255,0.7);
      border:1px solid var(--border-color);
      font-weight:900;
      font-variant-numeric:tabular-nums;
    }
    html.dark .pill{background:rgba(15,23,42,0.75)}

    @media (max-width:1200px){
      .slide{padding:40px}
      h1{font-size:2.5rem}
      h2{font-size:2rem}
      p,li{font-size:1.15rem}
      .content-grid{grid-template-columns:1fr;gap:1.5rem;height:auto}
      .center-content{height:auto}
      .nav{flex-wrap:wrap;justify-content:center}
      select.jump{max-width:220px}
    }

    /* Print */
    @media print{
      body{overflow:visible}
      .nav,.topbar,.notes,.overlay,.modal,.layers,.laser-dot,.progress{display:none !important}
      .slide-container{height:auto}
      .slide{
        position:relative;opacity:1;transform:none;
        page-break-after:always;
        height:auto;min-height:100vh;
        box-shadow:none;
      }
    }
  </style>
</head>

<body>
  <!-- Progress -->
  <div class="progress"><div id="progressBar"></div></div>

  <!-- Topbar: slide counter + timer -->
  <div class="topbar">
    <div class="left">
      <div class="chip mono" id="slideCounter">1 / 15</div>
      <div class="chip mono" id="timerChip">⏱ 00:00 / 12:00</div>
      <div class="chip" id="autoChip" style="display:none;">▶ Auto</div>
    </div>
    <div class="right">
      <div class="chip" id="modeChip">Mode: Normal</div>
    </div>
  </div>

  <!-- Presenter notes -->
  <div class="notes" id="notesBox">
    <h4>Бележки (P)</h4>
    <p id="notesText">—</p>
  </div>

  <!-- Laser dot -->
  <div class="laser-dot" id="laserDot"></div>

  <!-- Drawing canvas layer -->
  <div class="layers">
    <canvas id="drawCanvas"></canvas>
  </div>

  <!-- Slides -->
  <div class="slide-container">

    <!-- SLIDE 1 -->
    <section class="slide active" data-slide="1" data-notes="10 сек: тема + какво прави системата. Премини бързо към целта.">
      <div class="center-content">
        <h1>ПРЕОБРАЗУВАТЕЛ ОТ СИСТЕМА ЗА<br>СЪХРАНЕНИЕ НА ЕНЕРГИЯ</h1>
        <p style="font-size:1.6rem;font-weight:650;color:var(--text-secondary);margin-bottom:2rem;">
          в хибриден автомобил
        </p>
        <p style="font-size:1.4rem;font-weight:900;">ТОНИ ЦОЧЕВ БОРОВСКИ</p>
        <p style="font-size:1.2rem;color:var(--text-secondary);">Факултетен № 901322008</p>
        <p style="font-size:1.1rem;color:var(--text-secondary);">Катедра „Силова електроника“ • 2026</p>
      </div>
    </section>

    <!-- SLIDE 2 -->
    <section class="slide" data-slide="2" data-notes="Цел + 3 задачи. Без детайли. Подчертай 48/24V, 1kW, interleaved, bidirectional."
      data-section="Въведение">
      <h2>ЦЕЛ И ЗАДАЧИ</h2>
      <div class="content-grid">
        <div class="content-left">
          <h3>Основна цел:</h3>
          <ul>
            <li>Проектиране на <span class="highlight">48V/24V, 1 kW</span> interleaved bidirectional DC/DC преобразувател</li>
            <li>Като част от <span class="highlight">HESS</span> (Hybrid Energy Storage System) в 48V mild-hybrid автомобил</li>
          </ul>
          <h3 style="margin-top:2rem;">Основни задачи:</h3>
          <ul>
            <li>Избор на топология, контролер и микроконтролер</li>
            <li>Оразмеряване на силовата схема</li>
            <li>Симулационни изследвания и анализ</li>
          </ul>
        </div>
        <div class="image-placeholder zoomable" data-title="Блок-схема на HESS" data-kind="placeholder">
          <h4>Тук постави блок-схема на HESS системата</h4>
          <p>Фигура от дипломната работа</p>
          <small>(клик за zoom)</small>
        </div>
      </div>
    </section>

    <!-- SLIDE 3 -->
    <section class="slide" data-slide="3" data-notes="Защо 48V: регулации, SELV, по-малки загуби в кабели, повече мощност за помощни системи."
      data-section="Контекст">
      <h2>АКТУАЛНОСТ НА 48V СИСТЕМИТЕ</h2>
      <div class="content-grid">
        <div>
          <ul>
            <li><span class="highlight">EURO 6/7 и CAFE</span> изисквания за CO₂ емисии</li>
            <li>48V mild-hybrid системи с мощност <span class="highlight">15-20 kW</span></li>
            <li>Диапазон <span class="highlight">&lt;60V DC</span> - попада в SELV категория</li>
            <li>Намалени загуби в кабелните снопове спрямо 12V</li>
            <li>Поддръжка на електрически спомагателни системи</li>
          </ul>
        </div>
        <div class="image-placeholder zoomable" data-title="Zonal архитектура 12V vs 48V" data-kind="placeholder">
          <h4>Zonal архитектура 12V vs 48V</h4>
          <p>Фигура 2 от дипломната работа</p>
          <small>(клик за zoom)</small>
        </div>
      </div>
    </section>

    <!-- SLIDE 4 -->
    <section class="slide" data-slide="4" data-notes="Какво е HESS: батерия + суперкондензатор. Подчертай параметрите (24V/375F, ESR)."
      data-section="HESS">
      <h2>HYBRID ENERGY STORAGE SYSTEM (HESS)</h2>
      <div class="content-grid">
        <div>
          <h3>Суперкондензаторен блок:</h3>
          <ul>
            <li><span class="highlight">24V / 375F</span> (9x 2.7V елемента в серия)</li>
            <li>Енергия: <span class="highlight">26.7 Wh</span></li>
            <li>CC заряд при 45A: <span class="highlight">2.2 минути</span></li>
            <li>ESR: <span class="highlight">2.1 mΩ</span> при 200 kHz</li>
          </ul>
        </div>
        <div class="image-placeholder zoomable" data-title="Блок-схема на задвижваща система" data-kind="placeholder">
          <h4>Блок-схема на задвижваща система</h4>
          <p>Фигура 5/6 от дипломната работа</p>
          <small>(клик за zoom)</small>
        </div>
      </div>
    </section>

    <!-- SLIDE 5 -->
    <section class="slide" data-slide="5" data-notes="Сравнение топологии: защо interleaved buck-boost печели (КПД, ripple, токове)."
      data-section="Топология">
      <h2>СРАВНЕНИЕ НА DC/DC ТОПЛОГИИ</h2>
      <div class="stats-grid">
        <div class="stat-card"><span class="stat-value">95-98%</span><span class="stat-label">Interleaved Buck-Boost</span></div>
        <div class="stat-card"><span class="stat-value">93-97%</span><span class="stat-label">4-switch Buck-Boost</span></div>
        <div class="stat-card"><span class="stat-value">88-94%</span><span class="stat-label">SEPIC / Zeta / Ćuk</span></div>
        <div class="stat-card"><span class="stat-value">✓</span><span class="stat-label">ИЗБРАНА ТОПЛОГИЯ</span></div>
      </div>
      <div class="image-placeholder zoomable" data-title="Схеми на топологиите (Фиг. 12–19)" data-kind="placeholder" style="margin-top:2rem;height:200px;">
        <h4>Схеми на топологиите</h4>
        <p>Фигури 12-19 от дипломната работа</p>
        <small>(клик за zoom)</small>
      </div>
    </section>

    <!-- SLIDE 6 -->
    <section class="slide" data-slide="6" data-notes="Interleaved: 2 фази 180°, по-ниски пулсации, 500W/канал, 200–400kHz."
      data-section="Топология">
      <h2>INTERLEAVED BIDIRECTIONAL BUCK-BOOST</h2>
      <div class="content-grid">
        <div>
          <ul>
            <li><span class="highlight">48V ↔ 24V</span>, 1 kW (500W на канал)</li>
            <li>Два канала с <span class="highlight">180°</span> фазова разлика</li>
            <li>Честота: <span class="highlight">200-400 kHz</span></li>
            <li>ISO 21780 съвместимост</li>
            <li>Минимални пулсации на вход/изход</li>
          </ul>
        </div>
        <div class="image-placeholder zoomable" data-title="Схема на топологията (Фиг. 26)" data-kind="placeholder">
          <h4>Схема на топологията</h4>
          <p>Фигура 26 от дипломната работа</p>
          <small>(клик за zoom)</small>
        </div>
      </div>
    </section>

    <!-- SLIDE 7 -->
    <section class="slide" data-slide="7" data-notes="LM5171-Q1: dual-channel, current-mode, I2C, DEM/FPWM, automotive диапазони."
      data-section="Контролер">
      <h2>УПРАВЛЯВАЩ КОНТРОЛЕР LM5171-Q1</h2>
      <div class="content-grid">
        <div>
          <ul>
            <li>Автомобилен квалифициран <span class="highlight">(ISO 21780)</span></li>
            <li><span class="highlight">Dual-channel</span> buck/boost контролер</li>
            <li>Average current mode control</li>
            <li>DEM/FPWM, I²C интерфейс</li>
            <li>HV: 80V, LV: 75V, <span class="highlight">-40..150°C</span></li>
          </ul>
        </div>
        <div class="image-placeholder zoomable" data-title="Блок-схема LM5171 (Фиг. 32)" data-kind="placeholder">
          <h4>Блок-схема LM5171</h4>
          <p>Фигура 32 от дипломната работа</p>
          <small>(клик за zoom)</small>
        </div>
      </div>
    </section>

    <!-- SLIDE 8 -->
    <section class="slide" data-slide="8" data-notes="STM32L552: PWM таймери, ADC+DMA, комуникации, low-power. За мониторинг и управление."
      data-section="Контролер">
      <h2>МИКРОКОНТРОЛЕР STM32L552</h2>
      <div class="content-grid">
        <div>
          <ul>
            <li>ARM Cortex-M33 <span class="highlight">TrustZone</span></li>
            <li>TIM1/TIM8: комплементарни PWM <span class="highlight">200 kHz</span></li>
            <li>ADC + DMA за мониторинг</li>
            <li>Комуникация: CAN-FD, SPI, UART, I²C</li>
            <li>Вътрешен SMPS, ниска консумация</li>
          </ul>
        </div>
        <div class="image-placeholder zoomable" data-title="Пинаут STM32L552 (Фиг. 38)" data-kind="placeholder">
          <h4>Пинаут STM32L552</h4>
          <p>Фигура 38 от дипломната работа</p>
          <small>(клик за zoom)</small>
        </div>
      </div>
    </section>

    <!-- SLIDE 9 -->
    <section class="slide" data-slide="9" data-notes="Пълна силова схема: портове HV/LV, MOSFET-и, сензори, ключови елементи."
      data-section="Схема">
      <h2>ПЪЛНА СИЛОВА СХЕМА</h2>
      <div style="height:70%;display:flex;flex-direction:column;align-items:center;justify-content:center;">
        <div class="image-placeholder zoomable" data-title="Пълна силова схема (Фиг. 37)" data-kind="placeholder" style="height:500px;width:80%;">
          <h4 style="font-size:1.3rem;">Пълна силова схема с LM5171 и MOSFETs</h4>
          <p>Фигура 37 от дипломната работа</p>
          <p style="margin-top:1rem;font-size:1.1rem;">
            HV порт: 48-52V | LV порт: 24V/375F | MOSFET: Si7336ADP
          </p>
          <small>(клик за zoom)</small>
        </div>
      </div>
    </section>

    <!-- SLIDE 10 -->
    <section class="slide" data-slide="10" data-notes="Параметри + мини-калкулатор (по желание): покажи P=V·I и груба оценка на загуби."
      data-section="Параметри">
      <h2>ОСНОВНИ ПАРАМЕТРИ</h2>
      <div class="stats-grid">
        <div class="stat-card"><span class="stat-value">48V ↔ 24V</span><span class="stat-label">Напрежения</span></div>
        <div class="stat-card"><span class="stat-value">1 kW</span><span class="stat-label">Мощност</span></div>
        <div class="stat-card"><span class="stat-value">95-98%</span><span class="stat-label">КПД</span></div>
        <div class="stat-card"><span class="stat-value">200 kHz</span><span class="stat-label">Честота</span></div>
        <div class="stat-card"><span class="stat-value">4.7 μH</span><span class="stat-label">Индуктивност</span></div>
        <div class="stat-card"><span class="stat-value">&lt;90°C</span><span class="stat-label">MOSFET Tj</span></div>
      </div>

      <!-- Live mini-widget -->
      <div class="widget" id="calcWidget" style="margin-top:22px;">
        <h3 style="margin-bottom:10px;">Live mini-калкулатор (за демонстрация)</h3>
        <div class="row">
          <div>
            <label>Изходно напрежение (Vlv) <span class="highlight" id="vOutLbl">24</span> V</label>
            <input type="range" id="vOut" min="18" max="30" value="24" step="1" />
          </div>
          <div>
            <label>Товарен ток (Ilv) <span class="highlight" id="iOutLbl">40</span> A</label>
            <input type="range" id="iOut" min="0" max="60" value="40" step="1" />
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <div>
            <label>КПД <span class="highlight" id="etaLbl">95</span> %</label>
            <input type="range" id="eta" min="88" max="99" value="95" step="1" />
          </div>
          <div>
            <label>Целева мощност (лимит) <span class="highlight" id="pLimLbl">1000</span> W</label>
            <input type="range" id="pLim" min="200" max="1200" value="1000" step="50" />
          </div>
        </div>
        <div class="out">
          <div class="pill">Pout: <span id="pOutVal">960</span> W</div>
          <div class="pill">Pin: <span id="pInVal">1011</span> W</div>
          <div class="pill">Ploss: <span id="pLossVal">51</span> W</div>
        </div>
        <p style="margin-top:10px;color:var(--text-secondary);font-weight:650;font-size:1.05rem;">
          *Калкулаторът е за “live” показване на зависимости. Реалните стойности са от WEBENCH/симулации.
        </p>
      </div>
    </section>

    <!-- SLIDE 11 -->
    <section class="slide" data-slide="11" data-notes="WEBENCH: загуби, кое доминира, IRMS. Сравни с целевия КПД."
      data-section="Резултати">
      <h2>TI WEBENCH РЕЗУЛТАТИ</h2>
      <div class="content-grid">
        <div>
          <h3>Загуби при 1 kW:</h3>
          <ul>
            <li>Обща мощност на загубите: <span class="highlight">90 W</span></li>
            <li>MOSFET загуби: <span class="highlight">5.4 W</span></li>
            <li>Индуктор: <span class="highlight">2.5 W</span></li>
            <li>Капацити: <span class="highlight">9 W</span> (ESR)</li>
            <li>Cin/Cout IRMS: <span class="highlight">17.7 A</span></li>
          </ul>
        </div>
        <div class="image-placeholder zoomable" data-title="WEBENCH таблица и графики" data-kind="placeholder">
          <h4>WEBENCH таблица и графики</h4>
          <p>Резултати от V.3 в дипломната</p>
          <small>(клик за zoom)</small>
        </div>
      </div>
    </section>

    <!-- SLIDE 12 -->
    <section class="slide" data-slide="12" data-notes="LTspice: базов модел без управление. Показва токове и напрежения за проверка."
      data-section="Резултати">
      <h2>LTSPICE СИМУЛАЦИИ</h2>
      <div class="content-grid">
        <div>
          <h3>Без управление (10ms):</h3>
          <ul>
            <li>L1=L2= <span class="highlight">10 μH</span></li>
            <li>R3=0.001Ω за измерване</li>
            <li>Измерени: IR1, IR2, IRload</li>
            <li>Vhv, Vlv напрежения</li>
          </ul>
        </div>
        <div class="image-placeholder zoomable" data-title="LTspice схема и вълнови форми (Фиг. 54–56)" data-kind="placeholder">
          <h4>LTspice схема и вълнови форми</h4>
          <p>Фигури 54-56 от дипломната</p>
          <small>(клик за zoom)</small>
        </div>
      </div>
    </section>

    <!-- SLIDE 13 -->
    <section class="slide" data-slide="13" data-notes="PSpice с LM5171: interleaving 60–420°, токове през L1/L2. Сравни с очакваното."
      data-section="Резултати">
      <h2>PSPICE + LM5171</h2>
      <div class="content-grid">
        <div>
          <h3>С LM5171-Q1 (14.84ms):</h3>
          <ul>
            <li>L1=L2= <span class="highlight">4.7 μH</span></li>
            <li>MOSFET: Si7336ADP</li>
            <li>Interleaving: <span class="highlight">60-420°</span></li>
            <li>Измерени токове през L1/L2</li>
          </ul>
        </div>
        <div class="image-placeholder zoomable" data-title="PSpice схема и резултати (Фиг. 57–62)" data-kind="placeholder">
          <h4>PSpice схема и резултати</h4>
          <p>Фигури 57-62 от дипломната</p>
          <small>(клик за zoom)</small>
        </div>
      </div>
    </section>

    <!-- SLIDE 14 -->
    <section class="slide" data-slide="14" data-notes="Заключение: 4 булета. 20–30 секунди. После Q&A."
      data-section="Финал">
      <div class="center-content">
        <h2 style="margin-bottom:3rem;">ЗАКЛЮЧЕНИЕ</h2>
        <ul style="max-width:800px;text-align:left;">
          <li><span class="highlight">✓</span> Проектиран 1 kW interleaved 48V/24V DC/DC преобразувател за HESS</li>
          <li><span class="highlight">✓</span> КПД 95-98%, MOSFET Tj &lt; 90°C, ниски пулсации</li>
          <li><span class="highlight">✓</span> LM5171-Q1 и STM32L552 - автомобилни стандарти</li>
          <li><span class="highlight">✓</span> Верифициран чрез LTspice, PSpice, WEBENCH симулации</li>
        </ul>
      </div>
    </section>

    <!-- SLIDE 15 -->
    <section class="slide" data-slide="15" data-notes="Благодарности. Ако има време: предложи бъдеща работа/хардуер реализация."
      data-section="Финал">
      <div class="center-content">
        <h1 style="font-size:3rem;margin-bottom:2rem;color:var(--accent-primary);">БЛАГОДАРЯ!</h1>
        <p style="font-size:1.6rem;margin-bottom:1rem;">за вниманието</p>
        <p style="font-size:1.4rem;color:var(--text-secondary);">Въпроси?</p>

        <!-- Example: PDF open button (embedded viewer) -->
        <button class="nav-btn nav-ghost" id="openPdfBtn" style="margin-top:22px;">
          Отвори PDF (пример)
        </button>
        <p style="margin-top:10px;color:var(--text-secondary);font-weight:650;font-size:1.05rem;">
          *Сложи твоя линк като <span class="highlight">data-pdf</span> (виж JS) или смени URL-а.
        </p>
      </div>
    </section>

  </div>

  <!-- Bottom nav -->
  <div class="nav">
    <button class="nav-btn" id="prevBtn" disabled>◀</button>
    <button class="nav-btn" id="nextBtn">▶</button>

    <button class="nav-btn nav-ghost" id="overviewBtn">Overview</button>
    <button class="nav-btn nav-ghost" id="notesBtn">Notes</button>

    <button class="nav-btn nav-ghost" id="laserBtn">Laser</button>
    <button class="nav-btn nav-ghost" id="penBtn">Pen</button>
    <button class="nav-btn nav-ghost" id="clearBtn">Clear</button>

    <button class="nav-btn nav-ghost" id="fsBtn">Full</button>
    <button class="nav-btn nav-ghost" id="darkBtn">Dark</button>

    <button class="nav-btn nav-ghost" id="autoBtn">Auto</button>
    <button class="nav-btn nav-ghost" id="printBtn">Print</button>

    <select class="jump" id="jumpSelect" title="Скок към секция/слайд"></select>

    <button class="nav-btn nav-ghost" id="helpBtn">?</button>
  </div>

  <!-- Help overlay -->
  <div class="overlay" id="helpOverlay">
    <div class="panel">
      <div class="row">
        <h3>Клавиши и режими</h3>
        <button class="icon-btn" id="closeHelp">Close</button>
      </div>
      <div class="grid">
        <div class="kbd"><code>← / A</code><div>Предишен слайд</div></div>
        <div class="kbd"><code>→ / D / Space</code><div>Следващ слайд</div></div>
        <div class="kbd"><code>#7</code><div>Директно към слайд (hash навигация)</div></div>
        <div class="kbd"><code>O</code><div>Overview (миниатюри)</div></div>
        <div class="kbd"><code>P</code><div>Presenter notes</div></div>
        <div class="kbd"><code>L</code><div>Laser pointer</div></div>
        <div class="kbd"><code>R</code><div>Pen (рисуване)</div></div>
        <div class="kbd"><code>C</code><div>Clear рисунки</div></div>
        <div class="kbd"><code>F</code><div>Fullscreen</div></div>
        <div class="kbd"><code>M</code><div>Dark mode</div></div>
        <div class="kbd"><code>T</code><div>Auto-play (репетиция)</div></div>
        <div class="kbd"><code>Esc</code><div>Затваря overlay/modals</div></div>
        <div class="kbd"><code>Enter</code><div>Zoom върху избран placeholder (ако е фокусиран)</div></div>
      </div>
      <p style="margin-top:12px;color:var(--text-secondary);font-weight:650;">
        Съвет: За истински фигури сложи <b>data-img="assets/fig26.png"</b> на .zoomable блоковете.
      </p>
    </div>
  </div>

  <!-- Overview overlay -->
  <div class="overlay" id="overviewOverlay">
    <div class="panel">
      <div class="row">
        <h3>Overview</h3>
        <button class="icon-btn" id="closeOverview">Close</button>
      </div>
      <div class="overview-grid" id="overviewGrid"></div>
    </div>
  </div>

  <!-- Image/PDF modal -->
  <div class="modal" id="mediaModal">
    <div class="modal-card">
      <div class="modal-top">
        <div class="modal-title" id="modalTitle">Viewer</div>
        <div class="modal-actions">
          <button class="icon-btn" id="zoomOutBtn">−</button>
          <button class="icon-btn" id="zoomInBtn">＋</button>
          <button class="icon-btn" id="resetZoomBtn">Reset</button>
          <button class="icon-btn" id="closeModalBtn">Close</button>
        </div>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    // =============================
    // Config
    // =============================
    const TARGET_MINUTES = 12;              // timer goal (change to 10/15 as you want)
    const AUTOPLAY_SECONDS = 18;            // per slide during rehearsal
    const PEN_WIDTH = 4;                    // drawing thickness

    // =============================
    // State
    // =============================
    let currentSlide = 1;
    const slides = Array.from(document.querySelectorAll('.slide'));
    const totalSlides = slides.length;

    let notesEnabled = false;
    let overviewOpen = false;
    let helpOpen = false;

    let laserEnabled = false;
    let penEnabled = false;

    let autoplayEnabled = false;
    let autoplayTimer = null;

    // Timer
    let startTime = Date.now();
    let timerTick = null;

    // Drawing
    const canvas = document.getElementById('drawCanvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    let lastPt = null;

    // Image zoom/pan
    let currentScale = 1;
    let panX = 0, panY = 0;
    let panning = false;
    let panStart = null;
    let mediaKind = null; // "img" | "pdf" | "placeholder"
    let imgEl = null;
    let iframeEl = null;

    // =============================
    // Elements
    // =============================
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');

    const progressBar = document.getElementById('progressBar');
    const slideCounter = document.getElementById('slideCounter');

    const timerChip = document.getElementById('timerChip');
    const autoChip = document.getElementById('autoChip');
    const modeChip = document.getElementById('modeChip');

    const notesBox = document.getElementById('notesBox');
    const notesText = document.getElementById('notesText');

    const helpBtn = document.getElementById('helpBtn');
    const helpOverlay = document.getElementById('helpOverlay');
    const closeHelp = document.getElementById('closeHelp');

    const overviewBtn = document.getElementById('overviewBtn');
    const overviewOverlay = document.getElementById('overviewOverlay');
    const closeOverview = document.getElementById('closeOverview');
    const overviewGrid = document.getElementById('overviewGrid');

    const notesBtn = document.getElementById('notesBtn');

    const laserBtn = document.getElementById('laserBtn');
    const penBtn = document.getElementById('penBtn');
    const clearBtn = document.getElementById('clearBtn');
    const laserDot = document.getElementById('laserDot');

    const fsBtn = document.getElementById('fsBtn');
    const darkBtn = document.getElementById('darkBtn');
    const autoBtn = document.getElementById('autoBtn');
    const printBtn = document.getElementById('printBtn');

    const jumpSelect = document.getElementById('jumpSelect');

    const mediaModal = document.getElementById('mediaModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const zoomInBtn = document.getElementById('zoomInBtn');
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    const resetZoomBtn = document.getElementById('resetZoomBtn');

    const openPdfBtn = document.getElementById('openPdfBtn');

    // Slide 10 mini-widget
    const vOut = document.getElementById('vOut');
    const iOut = document.getElementById('iOut');
    const eta = document.getElementById('eta');
    const pLim = document.getElementById('pLim');

    const vOutLbl = document.getElementById('vOutLbl');
    const iOutLbl = document.getElementById('iOutLbl');
    const etaLbl = document.getElementById('etaLbl');
    const pLimLbl = document.getElementById('pLimLbl');

    const pOutVal = document.getElementById('pOutVal');
    const pInVal = document.getElementById('pInVal');
    const pLossVal = document.getElementById('pLossVal');

    // =============================
    // Helpers
    // =============================
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

    function setModeChip(){
      const bits = [];
      if (notesEnabled) bits.push('Notes');
      if (overviewOpen) bits.push('Overview');
      if (laserEnabled) bits.push('Laser');
      if (penEnabled) bits.push('Pen');
      if (autoplayEnabled) bits.push('Auto');
      if (document.documentElement.classList.contains('dark')) bits.push('Dark');
      modeChip.textContent = 'Mode: ' + (bits.length ? bits.join(' • ') : 'Normal');
    }

    function fmtTime(sec){
      sec = Math.max(0, Math.floor(sec));
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    }

    // =============================
    // Navigation / Hash
    // =============================
    function readHash(){
      const h = (location.hash || '').replace('#','').trim();
      const n = parseInt(h, 10);
      if (!Number.isNaN(n)) currentSlide = clamp(n, 1, totalSlides);
    }
    function writeHash(){
      history.replaceState(null, '', '#' + currentSlide);
    }

    function updateNotes(){
      const active = slides[currentSlide - 1];
      notesText.textContent = active?.getAttribute('data-notes') || '—';
      notesBox.style.display = notesEnabled ? 'block' : 'none';
    }

    function updateProgress(){
      const pct = totalSlides <= 1 ? 0 : ((currentSlide - 1) / (totalSlides - 1)) * 100;
      progressBar.style.width = `${pct}%`;
    }

    function updateCounter(){
      slideCounter.textContent = `${currentSlide} / ${totalSlides}`;
    }

    function updateButtons(){
      prevBtn.disabled = currentSlide === 1;
      nextBtn.textContent = currentSlide === totalSlides ? 'Край' : '▶';
    }

    function renderSlides(){
      slides.forEach((slide, idx) => {
        slide.classList.remove('active','prev');
        const i = idx + 1;
        if (i === currentSlide) slide.classList.add('active');
        else if (i < currentSlide) slide.classList.add('prev');
      });
    }

    function goToSlide(n, updateUrl=true){
      currentSlide = clamp(n, 1, totalSlides);
      renderSlides();
      updateButtons();
      updateCounter();
      updateProgress();
      updateNotes();
      if (updateUrl) writeHash();
      jumpSelect.value = String(currentSlide);
      setModeChip();
    }

    function next(){
      if (currentSlide < totalSlides) goToSlide(currentSlide + 1, true);
      else goToSlide(1, true);
    }
    function prev(){
      if (currentSlide > 1) goToSlide(currentSlide - 1, true);
    }

    window.addEventListener('hashchange', () => {
      readHash();
      goToSlide(currentSlide, false);
    });

    // =============================
    // Timer
    // =============================
    function resetTimer(){
      startTime = Date.now();
    }
    function tickTimer(){
      const elapsed = (Date.now() - startTime) / 1000;
      const target = TARGET_MINUTES * 60;
      timerChip.textContent = `⏱ ${fmtTime(elapsed)} / ${fmtTime(target)}`;

      // color hint
      const over = elapsed - target;
      if (over > 0) {
        timerChip.style.borderColor = 'rgba(255, 0, 0, 0.55)';
      } else if (elapsed > target * 0.85) {
        timerChip.style.borderColor = 'rgba(245, 158, 11, 0.7)';
      } else {
        timerChip.style.borderColor = 'var(--border-color)';
      }
    }

    // =============================
    // Overview
    // =============================
    function buildOverview(){
      overviewGrid.innerHTML = '';
      slides.forEach((slide, idx) => {
        const i = idx + 1;
        const h2 = slide.querySelector('h2');
        const h1 = slide.querySelector('h1');
        const title = (h2?.textContent || h1?.textContent || `Слайд ${i}`).trim().replace(/\s+/g,' ');
        const section = slide.getAttribute('data-section') || '';
        const div = document.createElement('div');
        div.className = 'thumb';
        div.innerHTML = `<b>${i}. ${title}</b><span>${section ? section + ' • ' : ''}#${i}</span>`;
        div.addEventListener('click', () => {
          closeOverviewOverlay();
          goToSlide(i, true);
        });
        overviewGrid.appendChild(div);
      });
    }

    function openOverviewOverlay(){
      overviewOpen = true;
      buildOverview();
      overviewOverlay.style.display = 'flex';
      setModeChip();
    }
    function closeOverviewOverlay(){
      overviewOpen = false;
      overviewOverlay.style.display = 'none';
      setModeChip();
    }
    function toggleOverview(){
      if (overviewOpen) closeOverviewOverlay();
      else openOverviewOverlay();
    }

    // =============================
    // Help
    // =============================
    function openHelp(){
      helpOpen = true;
      helpOverlay.style.display = 'flex';
    }
    function closeHelpOverlay(){
      helpOpen = false;
      helpOverlay.style.display = 'none';
    }
    function toggleHelp(){
      if (helpOpen) closeHelpOverlay();
      else openHelp();
    }

    // =============================
    // Fullscreen / Dark / Print
    // =============================
    function toggleFullscreen(){
      if (!document.fullscreenElement) document.documentElement.requestFullscreen?.();
      else document.exitFullscreen?.();
    }
    function toggleDark(){
      document.documentElement.classList.toggle('dark');
      setModeChip();
    }

    // =============================
    // Auto-play
    // =============================
    function setAutoplay(on){
      autoplayEnabled = on;
      autoChip.style.display = autoplayEnabled ? 'inline-flex' : 'none';
      if (autoplayTimer) { clearInterval(autoplayTimer); autoplayTimer = null; }
      if (autoplayEnabled) {
        autoplayTimer = setInterval(() => next(), AUTOPLAY_SECONDS * 1000);
      }
      setModeChip();
    }
    function toggleAutoplay(){ setAutoplay(!autoplayEnabled); }

    // =============================
    // Laser + Pen
    // =============================
    function resizeCanvas(){
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(window.innerWidth * dpr);
      canvas.height = Math.floor(window.innerHeight * dpr);
      canvas.style.width = window.innerWidth + 'px';
      canvas.style.height = window.innerHeight + 'px';
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
    }

    function setLaser(on){
      laserEnabled = on;
      if (!laserEnabled) laserDot.style.display = 'none';
      if (laserEnabled && penEnabled) setPen(false); // avoid conflicts
      setModeChip();
    }

    function setPen(on){
      penEnabled = on;
      if (penEnabled && laserEnabled) setLaser(false);
      canvas.style.pointerEvents = penEnabled ? 'auto' : 'none';
      setModeChip();
    }

    function clearDrawing(){
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function pointerPos(e){
      const x = e.clientX ?? (e.touches && e.touches[0]?.clientX) ?? 0;
      const y = e.clientY ?? (e.touches && e.touches[0]?.clientY) ?? 0;
      return {x, y};
    }

    // Mouse move for laser
    document.addEventListener('mousemove', (e) => {
      if (!laserEnabled) return;
      const {x,y} = pointerPos(e);
      laserDot.style.left = x + 'px';
      laserDot.style.top = y + 'px';
      laserDot.style.display = 'block';
    });

    // Pen drawing
    function startDraw(e){
      if (!penEnabled) return;
      drawing = true;
      lastPt = pointerPos(e);
    }
    function moveDraw(e){
      if (!penEnabled || !drawing) return;
      const pt = pointerPos(e);
      ctx.strokeStyle = 'rgba(255, 59, 48, 0.92)'; // red ink
      ctx.lineWidth = PEN_WIDTH;
      ctx.beginPath();
      ctx.moveTo(lastPt.x, lastPt.y);
      ctx.lineTo(pt.x, pt.y);
      ctx.stroke();
      lastPt = pt;
    }
    function endDraw(){
      drawing = false;
      lastPt = null;
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', moveDraw);
    window.addEventListener('mouseup', endDraw);

    // touch
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDraw(e); }, {passive:false});
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); moveDraw(e); }, {passive:false});
    canvas.addEventListener('touchend', (e) => { e.preventDefault(); endDraw(); }, {passive:false});

    // =============================
    // Media modal (images / placeholders / pdf)
    // =============================
    function resetMediaTransform(){
      currentScale = 1;
      panX = 0; panY = 0;
      applyMediaTransform();
    }

    function applyMediaTransform(){
      if (mediaKind !== 'img' || !imgEl) return;
      imgEl.style.transform = `translate(${panX}px, ${panY}px) scale(${currentScale})`;
    }

    function openImageViewer({title, src, placeholderText}){
      mediaKind = src ? 'img' : 'placeholder';
      modalTitle.textContent = title || 'Viewer';
      modalBody.innerHTML = '';
      imgEl = null; iframeEl = null;

      if (src) {
        const img = document.createElement('img');
        img.src = src;
        img.alt = title || 'image';
        img.style.maxWidth = 'none';
        img.style.maxHeight = 'none';
        img.style.transform = 'translate(0px,0px) scale(1)';
        img.style.cursor = 'grab';
        imgEl = img;
        modalBody.appendChild(imgEl);

        imgEl.addEventListener('mousedown', (e) => {
          if (mediaKind !== 'img') return;
          panning = true;
          imgEl.style.cursor = 'grabbing';
          panStart = {x: e.clientX, y: e.clientY, px: panX, py: panY};
        });
        window.addEventListener('mousemove', (e) => {
          if (!panning || !panStart) return;
          panX = panStart.px + (e.clientX - panStart.x);
          panY = panStart.py + (e.clientY - panStart.y);
          applyMediaTransform();
        });
        window.addEventListener('mouseup', () => {
          if (!panning) return;
          panning = false;
          if (imgEl) imgEl.style.cursor = 'grab';
          panStart = null;
        });

        modalBody.addEventListener('wheel', (e) => {
          if (mediaKind !== 'img') return;
          e.preventDefault();
          const delta = Math.sign(e.deltaY);
          const factor = delta > 0 ? 0.92 : 1.08;
          currentScale = clamp(currentScale * factor, 0.25, 6);
          applyMediaTransform();
        }, { passive:false });

      } else {
        // Placeholder zoom view
        const div = document.createElement('div');
        div.style.width = '100%';
        div.style.height = '100%';
        div.style.display = 'flex';
        div.style.alignItems = 'center';
        div.style.justifyContent = 'center';
        div.style.padding = '24px';
        div.style.background = 'linear-gradient(135deg, rgba(226,232,240,0.35), rgba(203,213,225,0.20))';
        div.style.color = 'white';
        div.innerHTML = `
          <div style="max-width:920px;width:100%;background:rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.15);border-radius:18px;padding:18px;">
            <div style="font-weight:900;font-size:1.25rem;margin-bottom:10px;">${title || 'Placeholder'}</div>
            <div style="opacity:.9;font-weight:650;line-height:1.5;">
              ${placeholderText || 'Тук постави изображение (data-img="...") за реален zoom.'}
            </div>
          </div>
        `;
        modalBody.appendChild(div);
      }

      resetMediaTransform();
      mediaModal.style.display = 'flex';
    }

    function openPdfViewer({title, url}){
      mediaKind = 'pdf';
      modalTitle.textContent = title || 'PDF Viewer';
      modalBody.innerHTML = '';
      imgEl = null; iframeEl = null;

      const iframe = document.createElement('iframe');
      iframe.src = url;
      iframeEl = iframe;
      modalBody.appendChild(iframeEl);

      mediaModal.style.display = 'flex';
    }

    function closeMedia(){
      mediaModal.style.display = 'none';
      modalBody.innerHTML = '';
      imgEl = null; iframeEl = null;
      mediaKind = null;
      panning = false;
      resetMediaTransform();
    }

    // Zoom controls (image only)
    function zoomIn(){ if (mediaKind==='img'){ currentScale = clamp(currentScale * 1.15, 0.25, 6); applyMediaTransform(); } }
    function zoomOut(){ if (mediaKind==='img'){ currentScale = clamp(currentScale / 1.15, 0.25, 6); applyMediaTransform(); } }

    // Hook clickables
    document.querySelectorAll('.zoomable').forEach(el => {
      el.addEventListener('click', () => {
        const title = el.getAttribute('data-title') || 'Viewer';
        const img = el.getAttribute('data-img'); // set this to your real figure path
        const kind = el.getAttribute('data-kind') || 'placeholder';
        const placeholderText = el.innerText?.trim() || '';

        if (img) {
          openImageViewer({ title, src: img });
        } else {
          openImageViewer({ title: title + ' (placeholder)', src: null, placeholderText });
        }
      });
    });

    // Example PDF open (replace with your real PDF URL or local file)
    openPdfBtn.addEventListener('click', () => {
      // If you have a local file: set url to "thesis.pdf" (must be in same folder)
      // Note: some browsers restrict file:// if not served via local server.
      openPdfViewer({
        title: 'PDF (пример)',
        url: 'about:blank'
      });
    });

    closeModalBtn.addEventListener('click', closeMedia);
    zoomInBtn.addEventListener('click', zoomIn);
    zoomOutBtn.addEventListener('click', zoomOut);
    resetZoomBtn.addEventListener('click', resetMediaTransform);

    // Close modal when clicking outside card
    mediaModal.addEventListener('click', (e) => {
      if (e.target === mediaModal) closeMedia();
    });

    // =============================
    // Jump menu
    // =============================
    function buildJumpMenu(){
      jumpSelect.innerHTML = '';
      slides.forEach((slide, idx) => {
        const i = idx + 1;
        const h2 = slide.querySelector('h2');
        const h1 = slide.querySelector('h1');
        const title = (h2?.textContent || h1?.textContent || `Слайд ${i}`).trim().replace(/\s+/g,' ');
        const sec = slide.getAttribute('data-section') || '';
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = `${String(i).padStart(2,'0')} • ${sec ? sec + ' — ' : ''}${title}`;
        jumpSelect.appendChild(opt);
      });
      jumpSelect.value = String(currentSlide);
    }

    jumpSelect.addEventListener('change', () => {
      const n = parseInt(jumpSelect.value, 10);
      if (!Number.isNaN(n)) goToSlide(n, true);
    });

    // =============================
    // Live mini-widget logic
    // =============================
    function updateCalc(){
      if (!vOut || !iOut || !eta || !pLim) return;

      const V = Number(vOut.value);
      const I = Number(iOut.value);
      const E = Number(eta.value) / 100;
      const limit = Number(pLim.value);

      vOutLbl.textContent = V;
      iOutLbl.textContent = I;
      etaLbl.textContent = Math.round(E * 100);
      pLimLbl.textContent = limit;

      let Pout = V * I;
      if (Pout > limit) Pout = limit;

      const Pin = E > 0 ? (Pout / E) : 0;
      const Ploss = Math.max(0, Pin - Pout);

      pOutVal.textContent = Math.round(Pout);
      pInVal.textContent = Math.round(Pin);
      pLossVal.textContent = Math.round(Ploss);
    }
    [vOut,iOut,eta,pLim].forEach(el => el && el.addEventListener('input', updateCalc));

    // =============================
    // Buttons
    // =============================
    prevBtn.addEventListener('click', prev);
    nextBtn.addEventListener('click', next);

    overviewBtn.addEventListener('click', toggleOverview);
    closeOverview.addEventListener('click', closeOverviewOverlay);
    overviewOverlay.addEventListener('click', (e) => { if (e.target === overviewOverlay) closeOverviewOverlay(); });

    notesBtn.addEventListener('click', () => { notesEnabled = !notesEnabled; updateNotes(); setModeChip(); });

    helpBtn.addEventListener('click', toggleHelp);
    closeHelp.addEventListener('click', closeHelpOverlay);
    helpOverlay.addEventListener('click', (e) => { if (e.target === helpOverlay) closeHelpOverlay(); });

    laserBtn.addEventListener('click', () => setLaser(!laserEnabled));
    penBtn.addEventListener('click', () => setPen(!penEnabled));
    clearBtn.addEventListener('click', clearDrawing);

    fsBtn.addEventListener('click', toggleFullscreen);
    darkBtn.addEventListener('click', toggleDark);

    autoBtn.addEventListener('click', toggleAutoplay);
    printBtn.addEventListener('click', () => window.print());

    // =============================
    // Keyboard + Touch slide nav
    // =============================
    document.addEventListener('keydown', (e) => {
      // If modal/overlays open
      if (e.key === 'Escape') {
        if (helpOpen) return closeHelpOverlay();
        if (overviewOpen) return closeOverviewOverlay();
        if (mediaModal.style.display === 'flex') return closeMedia();
        // If nothing open, disable tools quickly
        if (laserEnabled) setLaser(false);
        if (penEnabled) setPen(false);
        return;
      }

      if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') prev();
      else if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') next();
      else if (e.key === ' ') { e.preventDefault(); next(); }

      else if (e.key === 'o' || e.key === 'O') toggleOverview();
      else if (e.key === 'p' || e.key === 'P') { notesEnabled = !notesEnabled; updateNotes(); setModeChip(); }

      else if (e.key === 'l' || e.key === 'L') setLaser(!laserEnabled);
      else if (e.key === 'r' || e.key === 'R') setPen(!penEnabled);
      else if (e.key === 'c' || e.key === 'C') clearDrawing();

      else if (e.key === 'f' || e.key === 'F') toggleFullscreen();
      else if (e.key === 'm' || e.key === 'M') toggleDark();

      else if (e.key === 't' || e.key === 'T') toggleAutoplay();

      else if (e.key === '?' ) toggleHelp();
      else if (e.key === '+' || e.key === '=') zoomIn();
      else if (e.key === '-' || e.key === '_') zoomOut();
    });

    // Touch/swipe for slides (on whole doc)
    let startX = 0;
    document.addEventListener('touchstart', (e) => {
      if (penEnabled) return; // avoid conflict
      startX = e.touches[0].clientX;
    }, {passive:true});
    document.addEventListener('touchend', (e) => {
      if (!startX) return;
      if (penEnabled) return;
      const endX = e.changedTouches[0].clientX;
      const diff = startX - endX;
      if (Math.abs(diff) > 50) diff > 0 ? next() : prev();
      startX = 0;
    }, {passive:true});

    // =============================
    // Init
    // =============================
    function init(){
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);

      buildJumpMenu();
      readHash();
      goToSlide(currentSlide, false);

      // Timer loop
      if (timerTick) clearInterval(timerTick);
      timerTick = setInterval(tickTimer, 250);
      tickTimer();

      updateCalc();
      setModeChip();
    }

    init();
  </script>
</body>
</html>
